---
- name: Create the prometheus-operator namespace
  kubernetes.core.k8s:
    name: "{{ prometheus_namespace }}"
    api_version: v1
    kind: Namespace
    state: present

- name: Install Prometheus Operator
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('template', 'prometheus-operator.yaml.j2') }}"

- name: Wait for Deployment to complete.
  kubernetes.core.k8s:
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: prometheus-operator
        namespace: "{{ prometheus_namespace }}"
      spec:
        template:
          metadata:
            labels:
              app.kubernetes.io/component: controller
              app.kubernetes.io/name: prometheus-operator
              k8s-app: prometheus-operator
        selector:
          matchLabels:
            k8s-app: prometheus-operator
          spec:
            containers:
              - resources:
                  limits:
                    cpu: 200m
                    memory: 200Mi
                  requests:
                    cpu: 100m
                    memory: 100Mi
                terminationMessagePath: /dev/termination-log
                name: prometheus-operator
    wait: yes
    wait_condition:
      type: Available
      status: True
